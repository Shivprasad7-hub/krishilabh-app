{% extends "layout.html" %}
{% block content %}
<h3 class="mb-3">ðŸ“Š Farmer Dashboard</h3>
<div class="row">
  <div class="col-md-4">
    <div class="card p-3 mb-3"><h5>Total Income</h5><h3>â‚¹ {{ income }}</h3></div>
  </div>
  <div class="col-md-4">
    <div class="card p-3 mb-3"><h5>Total Expense</h5><h3>â‚¹ {{ expense }}</h3></div>
  </div>
  <div class="col-md-4">
    <div class="card p-3 mb-3"><h5>Net Profit</h5><h3>â‚¹ {{ profit }}</h3></div>
  </div>
</div>

<div class="row">
  <div class="col-md-6">
    <div class="card p-3 mb-3">
      <h5>Income vs Expense</h5>
      <canvas id="incExp"></canvas>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card p-3 mb-3">
      <h5>Crop-wise Income</h5>
      <canvas id="cropChart"></canvas>
    </div>
  </div>
</div>

<div class="card p-3 mb-3">
  <h5>Records</h5>
  <table class="table table-striped table-fixed">
    <thead class="table-success"><tr><th>Crop</th><th>Income</th><th>Expense</th></tr></thead>
    <tbody>
      {% for r in records %}
      <tr><td>{{ r['crop'] }}</td><td>â‚¹ {{ r['income'] }}</td><td>â‚¹ {{ r['expense'] }}</td></tr>
      {% endfor %}
    </tbody>
  </table>
  <div class="mt-2">
    <a class="btn btn-outline-success" href="{{ url_for('add_data') }}">âž• Add Data</a>
    <a class="btn btn-outline-primary" href="{{ url_for('export_pdf') }}">ðŸ“‘ Download PDF</a>
    <a class="btn btn-outline-primary" href="{{ url_for('export_excel') }}">ðŸ“Š Download Excel</a>
    <a class="btn btn-warning" href="{{ url_for('weather', village='Belagavi') }}">ðŸŒ¦ Weather & Suggestions</a>
  </div>
</div>

<div class="card p-3 mb-3">
  <h5>ðŸ¤– Smart Tips</h5>
  <ul>
    {% for tip in tips %}<li>{{ tip }}</li>{% endfor %}
  </ul>
</div>

<div class="card p-3 mb-3">
  <h5>ðŸ’° Market Prices</h5>
  <table class="table"><thead class="table-warning"><tr><th>Crop</th><th>Market Price (â‚¹/qtl)</th></tr></thead>
  <tbody>{% for c,p in market_prices.items() %}<tr><td>{{ c }}</td><td>â‚¹ {{ p }}</td></tr>{% endfor %}</tbody></table>
  <canvas id="marketChart"></canvas>
</div>

<div class="card p-3 mb-3">
  <h5>ðŸ‘« Community</h5>
  <form method="POST" action="{{ url_for('post_question') }}">
    <div class="mb-2"><input class="form-control" name="title" placeholder="Question title" required></div>
    <div class="mb-2"><textarea class="form-control" name="body" rows="2" placeholder="Write your question..."></textarea></div>
    <button class="btn btn-success">Post</button>
  </form>
  <hr>
  {% for q in questions %}
  <div class="mb-2"><strong>{{ q['title'] }}</strong><p>{{ q['body'] }}</p></div>
  {% endfor %}
</div>

<!-- Google Translate -->
<div id="google_translate_element" class="mt-3"></div>
<script type="text/javascript">
  function googleTranslateElementInit() {
    new google.translate.TranslateElement({pageLanguage: 'en', includedLanguages: 'en,hi,kn,te,ta,mr'}, 'google_translate_element');
  }
</script>
<script src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

<script>
const income={{ income }};
const expense={{ expense }};
new Chart(document.getElementById('incExp'), {type:'bar', data:{
  labels:['Income','Expense'], datasets:[{label:'â‚¹', data:[income, expense]}]
}});

const cropLabels = {{ records | map(attribute='crop') | list | tojson }};
const cropIncome = {{ records | map(attribute='income') | list | tojson }};
new Chart(document.getElementById('cropChart'), {type:'pie', data:{labels:cropLabels, datasets:[{data:cropIncome}]}});

const marketLabels = {{ market_prices.keys() | list | tojson }};
const marketData = {{ market_prices.values() | list | tojson }};
const farmerPrices = marketLabels.map(l => {
  const rec = {{ records | tojson }}.find(r => r.crop.toLowerCase() === l.toLowerCase());
  return rec ? rec.income : 0;
});
new Chart(document.getElementById('marketChart'), {type:'bar', data:{
  labels:marketLabels, datasets:[{label:'Market', data:marketData}, {label:'You', data:farmerPrices}]
}});
</script>
{% endblock %}